---
title: "Чтение файлов и шаблонизация"
description: "Чтение файлов и шаблонизация"
sidebar:
  order: 6
---

**Цель**: изучить возможности работы с файловой системой, отправки ответа с содержимым файлов и правильными заголовками.

## Содержание и порядок выполнения лабораторной работы:

Изучить документацию модуля node:fs, работу со строками, санитизация html.

### Чтение и отправка данных из файлов

1. Продолжить работу на ветке из прошлого занятия и дописать новый функционал.
1. Добавить в проект папку public. В ней разместить index.html, style.css и normalize.css/reset.css, взяв файлы из работ прошлого семестра. Другой вариант - добавить свои файлы index.html, style.css с минимальным содержимым, но корректным содержимым.
1. Также добавить страницу 404.html с заголовком об ошибке.
1. Синхронно считать файлы в память с помощью модуля fs. Вы получите объект Buffer, что работать с ним как со строкой используйте метод toString().
1. С помощью статического метода [Buffer.byteLength(string[, encoding])](https://nodejs.org/api/buffer.html#static-method-bufferbytelengthstring-encoding) посчитать длину строки.
1. Создать объект, в котором ключами являются пути до файлов от корня, например, /index.html, а значениями вложенные объекты, в которых содержится само содержимое файла, его длина и тип контента (text/html, text/css).
1. Написать функцию, которая из входящего запроса по url ищет совпадение в объекте с содержимым файлов, при нахождении совпадений, подготавливает ответ устанавливая заголовки 'content-type', 'content-length' и тело ответа. Если url ведет на корень /, то в ответе отправить index.html.
1. Тестировать можно как с помощью браузера, так и REST Client.

### Шаблонизация

1. Создать папку templates. В ней разместить файл lastcomment.html. К этому файлу подключить style.css. В lastcomment.html добавить разметку под последний комментарий с именем и текстовым содержимым. В шаблоне, где должны появиться имя и комментарий, выделите с двух сторон обозначение редко встречаемой комбинацией символов, например, %% обозначение %% или {{ обозначение }}.
1. Данная страница должна возвращаться по запросу на url /lastcomment.html. Перед тем как ее отправить в ответе, замените с помощью метода строки replace обозначения на реальные данные из массива комментариев, выполнив минимальную санитизацию данных с помощью функции ниже.
1. Рассчитайте длину тела ответа, подготовьте заголовки и отправьте ответ.

```js
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
```

### Общая логика

1. Сервер должен последовательно искать совпадения по url. Сначала в объекте со статическими файлами, потом с шаблонами, затем по оставшимся вариантам. Если совпадения не найдено, то возвращается ответ с кодом 404 и содержимым файла 404.html.
1. Тестировать можно как с помощью браузера, так и REST Client.
1. Если вы сталкиваетесь с ситуацией, когда вы пишете схожую логику в разных местах проекта, подумайте как ее можно обобщить и выносите в отдельные вспомогательные функции.

## Результаты выполнения лабораторной работы:

Работающий локально сервер с логикой, которая соответствует требованиям. Код отформатирован, не содержит ошибок и замечаний от статического анализа кода ESLint, сохранен в системе контроля версий.

## Источники

1. [Официальный сайт Node](https://nodejs.org/en/)
1. [Введение в Node на английском](https://nodejs.dev/en/learn/)
1. [Введение в Node на русском](https://nodejsdev.ru/guides/)
1. [Руководство по Node на русском (PDF)](https://ruvds.com/img/other/ee86eb4f-db9f-48d3-8094-c76e14414678.pdf)
1. [Курс по Node](https://habr.com/ru/post/485294/)
1. [JSON](https://doka.guide/tools/json/)

## Вопросы для защиты

1. Назовите примеры значений заголовка Content-Type.
1. Чем отличается синхронное чтение файлов от асинхронных.
1. Для чего устанавливается заголовок content-length?
1. Какие минусы и плюсы есть у варианта чтения файлов в начале запуска сервера?
1. Как искать и заменять контент в строках?
1. Что делает функция escapeHtml?
