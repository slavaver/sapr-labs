---
title: "Auth"
description: "Auth"
sidebar:
  order: 10
---

**Цель**: познакомиться с понятиями идентификации, аутентификации и авторизации. Реализовать аутентификацию основанную на сессиях.

## Содержание и порядок выполнения лабораторной работы:

Изучите понятия идентификации, аутентификации, авторизации.

**Предупреждение! Это не полная реализация аутентификации, поэтому не используйте подобное для реальных проектов**

### Изменения в базе данных

Таблица пользователей теперь позволяет хранить имя как текст и с требованием к уникальности этого значения, хеш пароля и соль.

Добавить таблицу для хранения идентификаторов сессий в виде текста.

### Регистрация

GET /signup - возвращает html с формой для регистрации. Форма, используя стандартные возможности браузера, отправляет POST запрос на /signup из формы отправляются имя и пароль. Оба поля обязательны для заполнения.

POST /signup - с помощью `querystring.decode` разбираете данные поступившие из формы. Проверяете наличие всех данных. Генерируете соль с помощью randomBytes длины 16 байт. Пароль нормализуете и хешируете с использованием функции scrypt с параметрами `{ N: 16384, r: 8, p: 1 }`. Соль и шех пароля приводятся к строке в hex формате для хранения в базе данных. Добавляете новую строку в базу данных. Если успешно добавлен пользователь то отправить пользователю страницу с сообщением о успешном добавлении. Другие ответы приведены в таблице.

| Метод | Путь    | Код | Описание                               | Ответ                                                          |
| ----- | ------- | --- | -------------------------------------- | -------------------------------------------------------------- |
| GET   | /signup | 200 | Форма для регистрации                  | html документ с формой из задания                              |
| POST  | /signup | 201 | Добавление нового пользователя         | html документ с сообщением об успешном добавлении пользователя |
| POST  | /signup | 400 | Ответ если не хватает данных в запросе | html документ с сообщением об ошибке запроса                   |
| POST  | /signup | 409 | Ответ если пользователь существует     | html документ с сообщением о существовании пользователя        |

### Вход

GET /login - возвращает форму для входа пользователя. Форма, используя стандартные возможности браузера, отправляет POST запрос на /login. Из формы отправляются имя и пароль. Оба поля обязательны для заполнения.

POST /login - с помощью `querystring.decode` разбираете данные поступившие из формы. Проверяете наличие всех данных. Из базы данных по имени извлекается хеш пароля и соль. Вычисляете хеш введенного паролю с добавлением соли из базы данных. Полученный хеш сравниваете с хешом из базы данных, если проверка успешно пройдена, то в базу данных добавляете идентификатор сессии (с помощью randomBytes и преобразованием к строке hex) и этот же идентификатор устанавливаете в куки со сроком жизни 1 день. Также установите httpOnly для этого куки.

| Метод | Путь   | Код | Описание                                                       | Ответ                                                         |
| ----- | ------ | --- | -------------------------------------------------------------- | ------------------------------------------------------------- |
| GET   | /login | 200 | Форма для входа                                                | html документ с формой из задания                             |
| POST  | /login | 200 | Добавление куки для клиента                                    | html документ с сообщением об успешном входе и установка куки |
| POST  | /login | 400 | Ответ если не хватает данных в запросе                         | html документ с сообщением об ошибке запроса                  |
| POST  | /login | 403 | Ответ если пользователь не найден или не подходит логин/пароль | html документ с сообщением о проблемах с именем и паролем     |

### Выход

POST /logout - устанавливаете куки с пустой строкой и заведомо истекшим временем жизни и удаляете этот идентификатор сессии из бд.

### Авторизация

Перед добавлением нового комментария, удалением существующего и редактированием. На сервере сначала проверяете наличие куки с сессией в запросе, затем проверяете есть ли такой идентификатор в базе данных. Если все в порядке, то вносите изменения, в противном случае, отправляете 403 ошибку о проблемах с доступом.

## Результаты выполнения лабораторной работы:

Работающий локально сервер с логикой, которая соответствует требованиям. Код отформатирован, не содержит ошибок и замечаний от статического анализа кода ESLint, сохранен в системе контроля версий.

## Источники

1. [Документация модуля crypto](https://nodejs.org/api/crypto.html)
1. [Шпаргалка по хранению паролей](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
1. [Шпаргалка по управлению сессиями](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
1. [Идентификация, аутентификация и авторизация — в чем разница?](https://www.kaspersky.ru/blog/identification-authentication-authorization-difference/29123/)
1. [Обзор способов и протоколов аутентификации в веб-приложениях](https://habr.com/ru/companies/dataart/articles/262817/)
1. [11 Authentication Mistakes And How To Fix Them](https://blog.openreplay.com/11-authentication-mistakes-and-how-to-fix-them/)

## Вопросы для защиты

1. Что такое идентификация?
1. Что такое аутентификация?
1. Что такое авторизация?
1. В каком формате отправляются данные из html формы?
1. Для чего нужна соль при хешировании паролей?
1. Опишите схему работы аутентификации с использовании сессии.
1. Как устанавливается и удаляется куки?
