---
title: "JS в браузере"
description: "DOM, fetch и работа с формами"
sidebar:
  order: 9
---

**Цель**: расширить функциональность веб-приложения для работы с 3D-моделями, изучить взаимодействие с файловой системой на сервере и мультиформатную (multipart/form-data) передачу данных.

## Подготовка

1. Повторить работу с формами HTML и изучить "multipart/form-data" для загрузки файлов.
1. Изучить работу с DOM и fetch.
1. Познакомиться с валидацией данных на стороне клиента.
1. Изучить возможности Node.js для работы с файловой системой по записи файлов.
1. Продолжить работу на ветке из прошлых занятий и модифицировать существующий функционал.
1. Установить зависимость [formidable](https://www.npmjs.com/package/formidable).

### Источники

- [Атрибут novalidate](https://doka.guide/html/novalidate/)
- [Доступные формы - doka.guide](https://doka.guide/a11y/accessible-forms/)
- [doka - fetch()](https://doka.guide/js/fetch/)
- [Мгновенная валидация форм](https://doka.guide/recipes/validation/)
- [«Современный учебник JavaScript - Документ»](https://learn.javascript.ru/document)
- [Multipart form submission](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Methods/POST#multipart_form_submission)
- [MIME types](https://developer.mozilla.org/ru/docs/Web/HTTP/Guides/MIME_types)

## Изменения в базе данных

Необходимо изменить схему базы данных, преобразовав таблицу комментариев в таблицу моделей:

1. Таблица моделей (бывшая таблица комментариев) с полями:
   - id (первичный ключ)
   - name (имя модели, обязательное поле)
   - description (описание модели, может быть null)
   - file_path (путь к файлу на сервере)
   - author_id (id автора)
   - time (время создания)

Таблицы пользователей и сессий остаются без изменений.

## Загрузка 3D-моделей

### Страница добавления модели

GET /models/upload - возвращает html с формой для загрузки новой 3D-модели. Форма должна содержать следующие поля:

- Имя модели (обязательное поле)
- Описание модели (необязательное поле)
- Поле для загрузки файла (принимает только файлы .stl)

Форма должна использовать атрибут `enctype="multipart/form-data"` и отправлять POST-запрос на `/models`.

В файле validate.js реализована валидация для полей форм. Готовое решение с разбором есть в статье [мгновенная валидация форм](https://doka.guide/recipes/validation/). Ваша задача разобраться в решении и внедрить к вашей форме.

| Метод | Путь           | Код | Описание                     | Ответ                                                  |
| ----- | -------------- | --- | ---------------------------- | ------------------------------------------------------ |
| GET   | /models/upload | 200 | Форма для загрузки 3D-модели | html документ с формой для загрузки                    |
| GET   | /models/upload | 403 | Доступ без авторизации       | html документ с сообщением о необходимости авторизации |

### Добавление новой модели

POST /models - принимает данные формы в формате multipart/form-data, включая файл .stl. Требует авторизации пользователя. Сохраняет файл на сервере в директорию `/uploads`, добавляет запись в БД с путем к файлу и перенаправляет на страницу с моделями.

| Метод | Путь    | Код | Описание                      | Ответ                                                  |
| ----- | ------- | --- | ----------------------------- | ------------------------------------------------------ |
| POST  | /models | 201 | Создание новой модели         | Перенаправление на главную страницу с моделями         |
| POST  | /models | 400 | Некорректные данные           | html документ с сообщением об ошибке валидации         |
| POST  | /models | 403 | Пользователь не авторизован   | html документ с сообщением о необходимости авторизации |
| POST  | /models | 415 | Неподдерживаемый формат файла | html документ с сообщением о поддерживаемых форматах   |

#### Требования к обработке загружаемых файлов

Для обработки данных формы с файлами необходимо:

1. Использовать стороннюю библиотеку `formidable` для парсинга multipart/form-data. Библиотека позволяет извлекать как файлы, так и обычные поля формы.
2. Создать директорию `uploads` при запуске сервера, если она не существует.
3. Проверять MIME-тип загружаемого файла для подтверждения, что это STL.
4. Генерировать уникальное имя файла для предотвращения коллизий.
5. Сохранять файл в директории uploads и записывать относительный путь в базу данных.

#### Процедура обработки загрузки файлов

Для правильной обработки данных формы с файлом на сервере необходимо:

Принять запрос с `Content-Type: multipart/form-data` используя библиотеку `formidable`.

```javascript
// В обработчике POST /models
const form = new formidable.IncomingForm();
form.parse(req, async (err, fields, files) => {
  if (err) {
    // Обработка ошибки
    return;
  }

  // fields содержит текстовые поля (name, description)
  // files содержит загруженные файлы (files.model)
});
```

Проверить наличие обязательных полей и валидировать данные.

Проверить тип файла (должен быть .stl).

Создать уникальное имя файла и определить путь для сохранения, например добавив префикс `Date.now()`.

Сохранить файл на диске скопировав files.model.


```javascript
fs.copyFile(modelFile.filepath, newPath, (err) => {
  if (err) {
    // Обработка ошибки при сохранении файла
    return;
  }

  // Файл успешно сохранен
});
```

Записать информацию о модели в базу данных.

Перенаправить пользователя на главную страницу.

```javascript
res.statusCode = 302;
res.setHeader("Location", "/");
res.end();
```

## Просмотр списка моделей

GET / или GET /index.html - возвращает страницу со списком доступных моделей с пагинацией. Страница должна загружать данные о моделях с помощью Fetch API и динамически отображать их.

На главной странице должен быть реализован JavaScript-код, который:

1. При загрузке страницы отправляет Fetch-запрос на `/models` с параметрами запроса для получения первой части данных.
2. Создает DOM-элементы для отображения списка моделей (имя, описание, автор, время добавления).
3. Реализует пагинацию с возможностью загрузки следующей/предыдущей страницы.
4. Предоставляет ссылку на форму добавления новой модели для авторизованных пользователей.

### Полезные методы DOM и свойства для реализации:

- `document.createElement()` — создание новых элементов
- `element.appendChild()` и `element.prepend()` — добавление элементов в DOM
- `element.innerHTML` — изменение содержимого элемента
- `element.setAttribute()` — установка атрибутов
- `element.classList.add()`, `element.classList.remove()` — управление классами
- `fetch()` — выполнение сетевых запросов
- `element.addEventListener()` — добавление обработчиков событий
- `URLSearchParams` — работа с параметрами URL для пагинации

## Авторизация

После входа в систему пользователь должен быть перенаправлен на главную страницу с моделями. При выходе из системы пользователь также возвращается на главную страницу.

Проверку авторизации пользователя можно вынести в middleware.

При успешном входе в систему (POST /login):

```javascript
// После успешной авторизации
res.statusCode = 302;
res.setHeader("Location", "/");
res.setHeader(
  "Set-Cookie", "..."
);
res.end();
```

При выходе из системы (POST /logout):

```javascript
// После успешного выхода
res.statusCode = 302;
res.setHeader("Location", "/");
res.setHeader("Set-Cookie", "...");
res.end();
```

## Возможная структура проекта

```
/src
  /controllers
    - auth.controller.js
    - models.controller.js
  /services
    - auth.service.js
    - models.service.js
    - file.service.js
  /repositories
    - users.repository.js
    - sessions.repository.js
    - models.repository.js
  /middlewares
    - auth.middleware.js
  /utils
    - crypto.js
    - cookie.js
    - file.utils.js
  /public
    - styles.css
    - script.js
    - index.html
    - validate.js
  /uploads
    - (здесь будут храниться загруженные файлы)
  - server.js
  - db.js
```

## Тестирование

Добавить новые тесты в файл .http и протестировать весь функционал.

Также проведите нагрузочное тестирование, чтобы убедиться что нет радикальной деградации скорости работы сервера.

## Требования к коду и результат выполнения

- Код отформатирован, не содержит ошибок и замечаний от статического анализа кода ESLint, сохранен в системе контроля версий.
- Отсутствуют ошибки в консоли.
- Работающий локально сервер с логикой, которая соответствует требованиям задания.
- Сервер проходит все тесты.

## Вопросы для защиты (3 вопроса по 10 баллов)

1. Отличия между разными типами кодирования формы (`enctype`).
1. Структура тела запроса/ответа при использовании multipart/form-data.
1. Особенности работы с MIME-типами и валидация файлов по их содержимому.
1. Что такое DOM, способы получения элементов и их модификации.
1. Атрибуты полей форм для добавления ограничений и валидации.
1. Валидация данных на стороне клиента и сервера.
1. Функция fetch, ее параметры. Promise и Response.
1. Получение данных из тела запроса.
