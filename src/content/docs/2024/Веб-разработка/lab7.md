---
title: "CRUD и авторизация"
description: "CRUD-операции и аутентификация на основе сессий"
sidebar:
  order: 8
---

**Цель**: изучить и реализовать базовые операции с БД, познакомиться с понятиями идентификации, аутентификации и авторизации.

## Подготовка

1. Повторить язык запросов SQL, основы SQLite и работу с ней в node.js.
2. Продолжить работу на ветке из прошлых занятий и дописать новый функционал.
3. Изучить понятия идентификации, аутентификации, авторизации.

### Источники

1. [Что такое API](https://doka.guide/tools/api/)
1. [Методы HTTP запроса](https://developer.mozilla.org/ru/docs/Web/HTTP/Methods)
1. [Updating Data in SQLite Database](https://www.sqlitetutorial.net/sqlite-nodejs/update/)
1. [Документация модуля crypto](https://nodejs.org/api/crypto.html)
1. [Шпаргалка по хранению паролей](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
1. [Шпаргалка по управлению сессиями](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
1. [Идентификация, аутентификация и авторизация — в чем разница?](https://www.kaspersky.ru/blog/identification-authentication-authorization-difference/29123/)
1. [Обзор способов и протоколов аутентификации в веб-приложениях](https://habr.com/ru/companies/dataart/articles/262817/)
1. [11 Authentication Mistakes And How To Fix Them](https://blog.openreplay.com/11-authentication-mistakes-and-how-to-fix-them/)

## Изменения в базе данных

Необходимо создать следующие таблицы в базе данных:

1. Таблица комментариев с полями:

   - id (первичный ключ)
   - comment (текст комментария)
   - author_id (id автора)
   - time (время создания)

2. Таблица пользователей с полями:

   - id (первичный ключ)
   - name (текстовое значение)
   - password_hash (хеш пароля)
   - salt (соль для хеширования)

3. Таблица сессий:
   - session_id (текстовое значение, уникальное)
   - user_id (id автора)

## Регистрация и авторизация

**Предупреждение! Это учебная реализация аутентификации, не используйте подобное для реальных проектов без дополнительных мер безопасности.**

### Регистрация

GET /signup - возвращает html с формой для регистрации. Форма, используя стандартные возможности браузера, отправляет POST запрос на /signup из формы отправляются имя и пароль. Оба поля обязательны для заполнения.

POST /signup - с помощью `querystring.decode` разбираете данные поступившие из формы. Проверяете наличие всех данных. Генерируете соль с помощью randomBytes длины 16 байт. Пароль нормализуете и хешируете с использованием функции scrypt с параметрами `{ N: 16384, r: 8, p: 1 }`. Соль и шех пароля приводятся к строке в hex формате для хранения в базе данных. Добавляете новую строку в базу данных. Если успешно добавлен пользователь то отправить пользователю страницу с сообщением о успешном добавлении. Другие ответы приведены в таблице.

| Метод | Путь    | Код | Описание                               | Ответ                                                          |
| ----- | ------- | --- | -------------------------------------- | -------------------------------------------------------------- |
| GET   | /signup | 200 | Форма для регистрации                  | html документ с формой из задания                              |
| POST  | /signup | 201 | Добавление нового пользователя         | html документ с сообщением об успешном добавлении пользователя |
| POST  | /signup | 400 | Ответ если не хватает данных в запросе | html документ с сообщением об ошибке запроса                   |
| POST  | /signup | 409 | Ответ если пользователь существует     | html документ с сообщением о существовании пользователя        |

### Вход

GET /login - возвращает форму для входа пользователя. Форма, используя стандартные возможности браузера, отправляет POST запрос на /login. Из формы отправляются имя и пароль. Оба поля обязательны для заполнения.

POST /login - с помощью `querystring.decode` разбираете данные поступившие из формы. Проверяете наличие всех данных. Из базы данных по имени извлекается хеш пароля и соль. Вычисляете хеш введенного паролю с добавлением соли из базы данных. Полученный хеш сравниваете с хешом из базы данных, если проверка успешно пройдена, то в базу данных добавляете идентификатор сессии (с помощью randomBytes и преобразованием к строке hex) и этот же идентификатор устанавливаете в куки со сроком жизни 1 день. Также установите httpOnly для этого куки.

| Метод | Путь   | Код | Описание                                                       | Ответ                                                         |
| ----- | ------ | --- | -------------------------------------------------------------- | ------------------------------------------------------------- |
| GET   | /login | 200 | Форма для входа                                                | html документ с формой из задания                             |
| POST  | /login | 200 | Добавление куки для клиента                                    | html документ с сообщением об успешном входе и установка куки |
| POST  | /login | 400 | Ответ если не хватает данных в запросе                         | html документ с сообщением об ошибке запроса                  |
| POST  | /login | 403 | Ответ если пользователь не найден или не подходит логин/пароль | html документ с сообщением о проблемах с именем и паролем     |

### Выход

POST /logout - устанавливает куки с пустой строкой и истекшим временем жизни, удаляет идентификатор сессии из базы данных.

| Метод | Путь    | Код | Описание         | Ответ                                                                     |
| ----- | ------- | --- | ---------------- | ------------------------------------------------------------------------- |
| POST  | /logout | 302 | Выход из системы | Перенаправление на страницу входа по URL, указанному в заголовке Location |

## Реализация CRUD-операций для комментариев

Сохраняя функционал из прошлых работ по чтению комментариев с пагинацией и добавлению нового комментария, добавить возможность изменения и удаления комментария, а также чтения одного комментария.

### Чтение комментариев

1. GET-запрос на `/comments?page=2&limit=5` возвращает список комментариев с пагинацией
2. GET-запрос на `/comments/2` (2 - это пример первичного ключа комментария) возвращает информацию о конкретном комментарии, например:

```json
{
  "id": 2,
  "comment": "Great work!",
  "name": "John Doe",
  "time": "2024-03-20T10:30:00Z"
}
```

Для работы с GET-запросами на `/comments/2` и `/comments?page=2&limit=5` в классе сервера можно перейти от получения функций напрямую по ключу из объекта к перебору ключей этого объекта и поиску совпадений, например через метод строки `.startsWith()`, а логику обработки запроса реализовать в соответствующем контроллере.

### Изменение комментариев с авторизацией

Перед добавлением нового комментария, удалением существующего и редактированием необходимо проверять:

1. Наличие куки с сессией в запросе
2. Наличие такого идентификатора в базе данных

Если все в порядке, то изменения вносятся, в противном случае отправляется 403 ошибка о проблемах с доступом.

1. POST-запрос на `/comments` принимает JSON с текстом комментария, требует авторизации пользователя, добавляет комментарий в БД, связывая его с текущим пользователем и возвращает его с id и временем создания.
2. PATCH-запрос на `/comments/2` принимает JSON вида `{"comment": "Новый текст"}` с обновленным текстом комментария, требует авторизации пользователя, проверяет, является ли текущий пользователь автором комментария, обновляет запись в БД и в теле ответа возвращает обновленный комментарий.
3. DELETE-запрос на `/comments/2` требует авторизации пользователя, проверяет, является ли текущий пользователь автором комментария, удаляет комментарий из БД, в теле ответа ничего не возвращается, только статус 204 (No Content).

## Обработка ошибок

Обработайте возможные ошибки:

- Если пришел некорректный запрос, возвращайте ошибку 400-й группы.
- Если произошла ошибка доступа, возвращайте ошибку 403 (Forbidden).
- Если ресурс не найден, возвращайте 404 (Not Found).
- Если ошибка возникла на стороне сервера, отправляйте ответ с кодом 500-й группы.


## Возможная структура проекта

```
/src
  /controllers
    - auth.controller.js
    - comments.controller.js
  /services
    - auth.service.js
    - comments.service.js
  /repositories
    - users.repository.js
    - sessions.repository.js
    - comments.repository.js
  /middlewares
    - auth.middleware.js
  /utils
    - crypto.js
    - cookie.js
  - server.js
  - db.js
```

### Тестирование

Добавить новые тесты в файл .http и протестировать весь функционал.

Также проведите нагрузочное тестирование, чтобы убедиться что нет радикальной деградации скорости работы сервера.

## Требования к коду и результат выполнения

- Код отформатирован, не содержит ошибок и замечаний от статического анализа кода ESLint, сохранен в системе контроля версий.
- Отсутствуют ошибки в консоли.
- Работающий локально сервер с логикой, которая соответствует требованиям задания.
- Сервер проходит все тесты.

## Вопросы для защиты

1. Идентификация, аутентификация и авторизация, их ключевые отличия.
1. CRUD-операции и соответствующие им HTTP-методы.
1. Различия между методами PUT и PATCH и сценарии их оптимального применения.
1. Форматы передачи данных из HTML-форм.
1. Назначение и механизм использования соли при хешировании паролей.
1. Схема работы аутентификации с использованием сессий.
1. Установка и удаление куки в HTTP-протоколе.
1. Меры безопасности при разработке систем аутентификации.
1. Методы и цели обработки ошибок на серверной стороне.
